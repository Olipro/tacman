<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Module: Packet::Core::CommonMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Module</span><br />Packet::Core::CommonMethods</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../../files/framework/core_rb.html">framework/core.rb</a>
        </td>
      </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">




  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000045">accept_connection</a></li>
  <li><a href="#M000058">add_periodic_timer</a></li>
  <li><a href="#M000059">add_timer</a></li>
  <li><a href="#M000060">cancel_timer</a></li>
  <li><a href="#M000062">check_for_timer_events</a></li>
  <li><a href="#M000046">complete_connection</a></li>
  <li><a href="#M000049">configure_socket_options</a></li>
  <li><a href="#M000042">connect</a></li>
  <li><a href="#M000064">decorate_handler</a></li>
  <li><a href="#M000056">handle_external_messages</a></li>
  <li><a href="#M000055">handle_internal_messages</a></li>
  <li><a href="#M000044">immediate_complete</a></li>
  <li><a href="#M000063">initialize_handler</a></li>
  <li><a href="#M000061">new</a></li>
  <li><a href="#M000057">read_external_socket</a></li>
  <li><a href="#M000043">reconnect</a></li>
  <li><a href="#M000047">remove_connection</a></li>
  <li><a href="#M000054">shutdown</a></li>
  <li><a href="#M000048">socket_really_connected?</a></li>
  <li><a href="#M000051">start_reactor</a></li>
  <li><a href="#M000050">start_server</a></li>
  <li><a href="#M000053">terminate_me</a></li>
  <li><a href="#M000052">user_thread_window</a></li>
  </ul>

<div class="sectiontitle">Included Modules</div>
<ul>
  <li><a href="../NbioHelper.html">NbioHelper</a></li>
</ul>





<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000061"></a><b>new</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000061_source')" id="l_M000061_source">show source</a> ]</p>
  <div id="M000061_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 221</span>
221:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
222:         <span class="ruby-ivar">@read_ios</span> <span class="ruby-operator">||=</span> []
223:         <span class="ruby-ivar">@write_ios</span> <span class="ruby-operator">||=</span> []
224:         <span class="ruby-ivar">@connection_completion_awaited</span> <span class="ruby-operator">||=</span> {}
225:         <span class="ruby-ivar">@connections</span> <span class="ruby-operator">||=</span> {}
226:         <span class="ruby-ivar">@listen_sockets</span> <span class="ruby-operator">||=</span> {}
227: 
228:         <span class="ruby-comment cmt"># @timer_hash = Packet::TimerStore</span>
229:         <span class="ruby-ivar">@timer_hash</span> <span class="ruby-operator">||=</span> {}
230:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000045"></a><b>accept_connection</b>(sock_opts)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000045_source')" id="l_M000045_source">show source</a> ]</p>
  <div id="M000045_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File framework/core.rb, line 65</span>
65:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">accept_connection</span>(<span class="ruby-identifier">sock_opts</span>)
66:         <span class="ruby-identifier">sock_io</span> = <span class="ruby-identifier">sock_opts</span>[<span class="ruby-identifier">:socket</span>]
67:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Someone is attempting a connection&quot;</span>
68:         <span class="ruby-keyword kw">begin</span>
69:           <span class="ruby-identifier">client_socket</span>,<span class="ruby-identifier">client_sockaddr</span> = <span class="ruby-identifier">sock_io</span>.<span class="ruby-identifier">accept_nonblock</span>
70:           <span class="ruby-identifier">client_socket</span>.<span class="ruby-identifier">setsockopt</span>(<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">IPPROTO_TCP</span>,<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">TCP_NODELAY</span>,<span class="ruby-value">1</span>)
71:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EAGAIN</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNABORTED</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EPROTO</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EINTR</span>
72:           <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;not ready yet&quot;</span>
73:           <span class="ruby-keyword kw">return</span>
74:         <span class="ruby-keyword kw">end</span>
75:         <span class="ruby-identifier">read_ios</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">client_socket</span>
76:         <span class="ruby-identifier">decorate_handler</span>(<span class="ruby-identifier">client_socket</span>,<span class="ruby-keyword kw">true</span>,<span class="ruby-identifier">client_sockaddr</span>,<span class="ruby-identifier">sock_opts</span>[<span class="ruby-identifier">:module</span>],<span class="ruby-operator">&amp;</span><span class="ruby-identifier">sock_opts</span>[<span class="ruby-identifier">:block</span>])
77:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000058"></a><b>add_periodic_timer</b>(interval,&amp;block)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000058_source')" id="l_M000058_source">show source</a> ]</p>
  <div id="M000058_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 204</span>
204:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_periodic_timer</span>(<span class="ruby-identifier">interval</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
205:         <span class="ruby-identifier">t_timer</span> = <span class="ruby-constant">PeriodicEvent</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">interval</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
206:         <span class="ruby-ivar">@timer_hash</span>[<span class="ruby-identifier">t_timer</span>.<span class="ruby-identifier">timer_signature</span>] = <span class="ruby-identifier">t_timer</span>
207:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">t_timer</span>
208:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000059"></a><b>add_timer</b>(elapsed_time,&amp;block)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000059_source')" id="l_M000059_source">show source</a> ]</p>
  <div id="M000059_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 210</span>
210:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_timer</span>(<span class="ruby-identifier">elapsed_time</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
211:         <span class="ruby-identifier">t_timer</span> = <span class="ruby-constant">Event</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">elapsed_time</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
212:         <span class="ruby-comment cmt"># @timer_hash.store(timer)</span>
213:         <span class="ruby-ivar">@timer_hash</span>[<span class="ruby-identifier">t_timer</span>.<span class="ruby-identifier">timer_signature</span>] = <span class="ruby-identifier">t_timer</span>
214:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">t_timer</span>
215:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000060"></a><b>cancel_timer</b>(t_timer)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000060_source')" id="l_M000060_source">show source</a> ]</p>
  <div id="M000060_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 217</span>
217:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cancel_timer</span>(<span class="ruby-identifier">t_timer</span>)
218:         <span class="ruby-ivar">@timer_hash</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_timer</span>.<span class="ruby-identifier">timer_signature</span>)
219:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000062"></a><b>check_for_timer_events</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000062_source')" id="l_M000062_source">show source</a> ]</p>
  <div id="M000062_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 232</span>
232:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_for_timer_events</span>
233:         <span class="ruby-ivar">@timer_hash</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>,<span class="ruby-identifier">timer</span><span class="ruby-operator">|</span>
234:           <span class="ruby-ivar">@timer_hash</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">timer</span>.<span class="ruby-identifier">cancel_flag</span>
235:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">timer</span>.<span class="ruby-identifier">run_now?</span>
236:             <span class="ruby-identifier">timer</span>.<span class="ruby-identifier">run</span>
237:             <span class="ruby-ivar">@timer_hash</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">timer</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:interval</span>)
238:           <span class="ruby-keyword kw">end</span>
239:         <span class="ruby-keyword kw">end</span>
240:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000046"></a><b>complete_connection</b>(t_sock,sock_opts)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000046_source')" id="l_M000046_source">show source</a> ]</p>
  <div id="M000046_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File framework/core.rb, line 79</span>
79:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">complete_connection</span>(<span class="ruby-identifier">t_sock</span>,<span class="ruby-identifier">sock_opts</span>)
80:         <span class="ruby-identifier">actually_connected</span> = <span class="ruby-keyword kw">true</span>
81:         <span class="ruby-keyword kw">begin</span>
82:           <span class="ruby-identifier">t_sock</span>.<span class="ruby-identifier">connect_nonblock</span>(<span class="ruby-identifier">sock_opts</span>[<span class="ruby-identifier">:sock_addr</span>])
83:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EISCONN</span>
84:           <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Socket already connected&quot;</span>
85:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span>
86:           <span class="ruby-identifier">actually_connected</span> = <span class="ruby-keyword kw">false</span>
87:         <span class="ruby-keyword kw">end</span>
88: 
89:         <span class="ruby-identifier">read_ios</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t_sock</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">actually_connected</span>
90:         <span class="ruby-identifier">write_ios</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_sock</span>)
91:         <span class="ruby-identifier">decorate_handler</span>(<span class="ruby-identifier">t_sock</span>,<span class="ruby-identifier">actually_connected</span>,<span class="ruby-identifier">sock_opts</span>[<span class="ruby-identifier">:sock_addr</span>],\
92:                            <span class="ruby-identifier">sock_opts</span>[<span class="ruby-identifier">:module</span>],<span class="ruby-operator">&amp;</span><span class="ruby-identifier">sock_opts</span>[<span class="ruby-identifier">:block</span>])
93:         <span class="ruby-identifier">connection_completion_awaited</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_sock</span>.<span class="ruby-identifier">fileno</span>)
94:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000049"></a><b>configure_socket_options</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000049_source')" id="l_M000049_source">show source</a> ]</p>
  <div id="M000049_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 113</span>
113:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">configure_socket_options</span>
114:         <span class="ruby-keyword kw">case</span> <span class="ruby-constant">RUBY_PLATFORM</span>
115:         <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/linux/</span>
116:           <span class="ruby-comment cmt"># 9 is currently TCP_DEFER_ACCEPT</span>
117:           <span class="ruby-ivar">@tcp_defer_accept_opts</span> = [<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">SOL_TCP</span>, <span class="ruby-value">9</span>, <span class="ruby-value">1</span>]
118:           <span class="ruby-ivar">@tcp_cork_opts</span> = [<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">SOL_TCP</span>, <span class="ruby-value">3</span>, <span class="ruby-value">1</span>]
119:         <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/freebsd(([1-4]\..{1,2})|5\.[0-4])/</span>
120:           <span class="ruby-comment cmt"># Do nothing, just closing a bug when freebsd &lt;= 5.4</span>
121:         <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/freebsd/</span>
122:           <span class="ruby-comment cmt"># Use the HTTP accept filter if available.</span>
123:           <span class="ruby-comment cmt"># The struct made by pack() is defined in /usr/include/sys/socket.h as accept_filter_arg</span>
124:           <span class="ruby-keyword kw">unless</span> <span class="ruby-value">`/sbin/sysctl -nq net.inet.accf.http`</span>.<span class="ruby-identifier">empty?</span>
125:             <span class="ruby-ivar">@tcp_defer_accept_opts</span> = [<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">SOL_SOCKET</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">SO_ACCEPTFILTER</span>, [<span class="ruby-value str">'httpready'</span>, <span class="ruby-keyword kw">nil</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'a16a240'</span>)]
126:           <span class="ruby-keyword kw">end</span>
127:         <span class="ruby-keyword kw">end</span>
128:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000042"></a><b>connect</b>(ip,port,t_module,&amp;block)
  </div>
  <div class="description">
  <p>
method
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000042_source')" id="l_M000042_source">show source</a> ]</p>
  <div id="M000042_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File framework/core.rb, line 37</span>
37:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connect</span>(<span class="ruby-identifier">ip</span>,<span class="ruby-identifier">port</span>,<span class="ruby-identifier">t_module</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
38:         <span class="ruby-identifier">t_socket</span> = <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AF_INET</span>,<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">SOCK_STREAM</span>,<span class="ruby-value">0</span>)
39:         <span class="ruby-identifier">t_sock_addr</span> = <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">sockaddr_in</span>(<span class="ruby-identifier">port</span>,<span class="ruby-identifier">ip</span>)
40:         <span class="ruby-identifier">t_socket</span>.<span class="ruby-identifier">setsockopt</span>(<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">IPPROTO_TCP</span>,<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">TCP_NODELAY</span>,<span class="ruby-value">1</span>)
41: 
42:         <span class="ruby-identifier">connection_completion_awaited</span>[<span class="ruby-identifier">t_socket</span>.<span class="ruby-identifier">fileno</span>] =
43:           { <span class="ruby-identifier">:sock_addr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">t_sock_addr</span>, <span class="ruby-identifier">:module</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">t_module</span>,<span class="ruby-identifier">:block</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">block</span> }
44:         <span class="ruby-keyword kw">begin</span>
45:           <span class="ruby-identifier">t_socket</span>.<span class="ruby-identifier">connect_nonblock</span>(<span class="ruby-identifier">t_sock_addr</span>)
46:           <span class="ruby-identifier">immediate_complete</span>(<span class="ruby-identifier">t_socket</span>,<span class="ruby-identifier">t_sock_addr</span>,<span class="ruby-identifier">t_module</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
47:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EINPROGRESS</span>
48:           <span class="ruby-identifier">write_ios</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t_socket</span>
49:         <span class="ruby-keyword kw">end</span>
50:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000064"></a><b>decorate_handler</b>(t_socket,actually_connected,sock_addr,t_module,&amp;block)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000064_source')" id="l_M000064_source">show source</a> ]</p>
  <div id="M000064_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 253</span>
253:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">decorate_handler</span>(<span class="ruby-identifier">t_socket</span>,<span class="ruby-identifier">actually_connected</span>,<span class="ruby-identifier">sock_addr</span>,<span class="ruby-identifier">t_module</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
254:         <span class="ruby-identifier">handler_instance</span> = <span class="ruby-identifier">initialize_handler</span>(<span class="ruby-identifier">t_module</span>)
255:         <span class="ruby-identifier">connection_callbacks</span>[<span class="ruby-identifier">:after_connection</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t_callback</span><span class="ruby-operator">|</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">t_callback</span>,<span class="ruby-identifier">handler_instance</span>,<span class="ruby-identifier">t_socket</span>)}
256:         <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">invoke_init</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">initialized</span>
257:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">actually_connected</span>
258:           <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">unbind</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:unbind</span>)
259:           <span class="ruby-keyword kw">return</span>
260:         <span class="ruby-keyword kw">end</span>
261:         <span class="ruby-identifier">t_signature</span> = <span class="ruby-constant">Guid</span>.<span class="ruby-identifier">hexdigest</span>
262:         <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">signature</span> = <span class="ruby-identifier">t_signature</span>
263:         <span class="ruby-identifier">connections</span>[<span class="ruby-identifier">t_socket</span>.<span class="ruby-identifier">fileno</span>] =
264:           <span class="ruby-constant">OpenStruct</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:socket</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">t_socket</span>, <span class="ruby-identifier">:instance</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">handler_instance</span>, <span class="ruby-identifier">:signature</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">t_signature</span>,<span class="ruby-identifier">:sock_addr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sock_addr</span>)
265:         <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">handler_instance</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block</span>
266:         <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">connection_completed</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:connection_completed</span>)
267:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000056"></a><b>handle_external_messages</b>(t_sock)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000056_source')" id="l_M000056_source">show source</a> ]</p>
  <div id="M000056_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 181</span>
181:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">handle_external_messages</span>(<span class="ruby-identifier">t_sock</span>)
182:         <span class="ruby-identifier">sock_fd</span> = <span class="ruby-identifier">t_sock</span>.<span class="ruby-identifier">fileno</span>
183:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">sock_opts</span> = <span class="ruby-identifier">listen_sockets</span>[<span class="ruby-identifier">sock_fd</span>]
184:           <span class="ruby-identifier">accept_connection</span>(<span class="ruby-identifier">sock_opts</span>)
185:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">extern_opts</span> = <span class="ruby-identifier">connection_completion_awaited</span>[<span class="ruby-identifier">sock_fd</span>]
186:           <span class="ruby-identifier">complete_connection</span>(<span class="ruby-identifier">t_sock</span>,<span class="ruby-identifier">extern_opts</span>)
187:         <span class="ruby-keyword kw">else</span>
188:           <span class="ruby-identifier">read_external_socket</span>(<span class="ruby-identifier">t_sock</span>)
189:         <span class="ruby-keyword kw">end</span>
190:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000055"></a><b>handle_internal_messages</b>(t_sock)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000055_source')" id="l_M000055_source">show source</a> ]</p>
  <div id="M000055_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 177</span>
177:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">handle_internal_messages</span>(<span class="ruby-identifier">t_sock</span>)
178:         <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Method should be implemented by concerned classes&quot;</span>
179:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000044"></a><b>immediate_complete</b>(t_socket,sock_addr,t_module,&amp;block)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000044_source')" id="l_M000044_source">show source</a> ]</p>
  <div id="M000044_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File framework/core.rb, line 58</span>
58:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">immediate_complete</span>(<span class="ruby-identifier">t_socket</span>,<span class="ruby-identifier">sock_addr</span>,<span class="ruby-identifier">t_module</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
59:         <span class="ruby-identifier">read_ios</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t_socket</span>
60:         <span class="ruby-identifier">write_ios</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_socket</span>)
61:         <span class="ruby-identifier">decorate_handler</span>(<span class="ruby-identifier">t_socket</span>,<span class="ruby-keyword kw">true</span>,<span class="ruby-identifier">sock_addr</span>,<span class="ruby-identifier">t_module</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
62:         <span class="ruby-identifier">connection_completion_awaited</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_socket</span>.<span class="ruby-identifier">fileno</span>)
63:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000063"></a><b>initialize_handler</b>(p_module)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000063_source')" id="l_M000063_source">show source</a> ]</p>
  <div id="M000063_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 242</span>
242:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize_handler</span>(<span class="ruby-identifier">p_module</span>)
243:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">p_module</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">p_module</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Class</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">p_module</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Module</span>))
244:         <span class="ruby-identifier">handler</span> =
245:           <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">p_module</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">p_module</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Class</span>))
246:             <span class="ruby-identifier">p_module</span>
247:           <span class="ruby-keyword kw">else</span>
248:             <span class="ruby-constant">Class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Connection</span>) { <span class="ruby-identifier">p_module</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">include</span> <span class="ruby-identifier">p_module</span> }
249:           <span class="ruby-keyword kw">end</span>
250:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">new</span>
251:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000057"></a><b>read_external_socket</b>(t_sock)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000057_source')" id="l_M000057_source">show source</a> ]</p>
  <div id="M000057_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 192</span>
192:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_external_socket</span>(<span class="ruby-identifier">t_sock</span>)
193:         <span class="ruby-identifier">handler_instance</span> = <span class="ruby-identifier">connections</span>[<span class="ruby-identifier">t_sock</span>.<span class="ruby-identifier">fileno</span>].<span class="ruby-identifier">instance</span>
194:         <span class="ruby-keyword kw">begin</span>
195:           <span class="ruby-identifier">t_data</span> = <span class="ruby-identifier">read_data</span>(<span class="ruby-identifier">t_sock</span>)
196:           <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">receive_data</span>(<span class="ruby-identifier">t_data</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:receive_data</span>)
197:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">DisconnectError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sock_error</span>
198:           <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">unbind</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">handler_instance</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:unbind</span>)
199:           <span class="ruby-identifier">connections</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_sock</span>.<span class="ruby-identifier">fileno</span>)
200:           <span class="ruby-identifier">read_ios</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_sock</span>)
201:         <span class="ruby-keyword kw">end</span>
202:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000043"></a><b>reconnect</b>(server,port,handler)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000043_source')" id="l_M000043_source">show source</a> ]</p>
  <div id="M000043_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File framework/core.rb, line 52</span>
52:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reconnect</span>(<span class="ruby-identifier">server</span>,<span class="ruby-identifier">port</span>,<span class="ruby-identifier">handler</span>)
53:         <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;invalid handler&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:connection_completed</span>)
54:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">handler</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">connections</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">handler</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">fileno</span>)
55:         <span class="ruby-identifier">connect</span>(<span class="ruby-identifier">server</span>,<span class="ruby-identifier">port</span>,<span class="ruby-identifier">handler</span>)
56:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000047"></a><b>remove_connection</b>(t_sock)
  </div>
  <div class="description">
  <p>
method removes the connection and closes the socket
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000047_source')" id="l_M000047_source">show source</a> ]</p>
  <div id="M000047_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 97</span>
 97:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove_connection</span>(<span class="ruby-identifier">t_sock</span>)
 98:         <span class="ruby-ivar">@read_ios</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_sock</span>)
 99:         <span class="ruby-ivar">@write_ios</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_sock</span>)
100:         <span class="ruby-identifier">connections</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t_sock</span>.<span class="ruby-identifier">fileno</span>)
101:         <span class="ruby-identifier">t_sock</span>.<span class="ruby-identifier">close</span>
102:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000054"></a><b>shutdown</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000054_source')" id="l_M000054_source">show source</a> ]</p>
  <div id="M000054_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 172</span>
172:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shutdown</span>
173:         <span class="ruby-comment cmt"># FIXME: close the open sockets</span>
174:         <span class="ruby-identifier">exit</span>
175:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000048"></a><b>socket_really_connected?</b>(t_sock)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000048_source')" id="l_M000048_source">show source</a> ]</p>
  <div id="M000048_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 104</span>
104:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">socket_really_connected?</span>(<span class="ruby-identifier">t_sock</span>)
105:         <span class="ruby-keyword kw">begin</span>
106:           <span class="ruby-identifier">t_data</span> = <span class="ruby-identifier">read_data</span>(<span class="ruby-identifier">t_sock</span>)
107:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
108:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">DisconnectError</span>
109:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
110:         <span class="ruby-keyword kw">end</span>
111:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000051"></a><b>start_reactor</b>()
  </div>
  <div class="description">
  <p>
method starts event loop in the process
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000051_source')" id="l_M000051_source">show source</a> ]</p>
  <div id="M000051_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 141</span>
141:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_reactor</span>
142:         <span class="ruby-constant">Signal</span>.<span class="ruby-identifier">trap</span>(<span class="ruby-value str">&quot;TERM&quot;</span>) { <span class="ruby-identifier">terminate_me</span> }
143:         <span class="ruby-constant">Signal</span>.<span class="ruby-identifier">trap</span>(<span class="ruby-value str">&quot;INT&quot;</span>) { <span class="ruby-identifier">shutdown</span> }
144:         <span class="ruby-identifier">loop</span> <span class="ruby-keyword kw">do</span>
145:           <span class="ruby-identifier">check_for_timer_events</span>
146:           <span class="ruby-identifier">user_thread_window</span> <span class="ruby-comment cmt">#=&gt; let user level threads run for a while</span>
147:           <span class="ruby-identifier">ready_fds</span> = <span class="ruby-identifier">select</span>(<span class="ruby-ivar">@read_ios</span>,<span class="ruby-ivar">@write_ios</span>,<span class="ruby-keyword kw">nil</span>,<span class="ruby-value">0</span><span class="ruby-value">.005</span>)
148:           <span class="ruby-comment cmt">#next if ready_fds.blank?</span>
149: 
150:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ready_fds</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">ready_fds</span>.<span class="ruby-identifier">empty?</span>
151: 
152:           <span class="ruby-identifier">ready_fds</span> = <span class="ruby-identifier">ready_fds</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
153:           <span class="ruby-identifier">ready_fds</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t_sock</span><span class="ruby-operator">|</span>
154:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">t_sock</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">UNIXSocket</span>
155:               <span class="ruby-identifier">handle_internal_messages</span>(<span class="ruby-identifier">t_sock</span>)
156:             <span class="ruby-keyword kw">else</span>
157:               <span class="ruby-identifier">handle_external_messages</span>(<span class="ruby-identifier">t_sock</span>)
158:             <span class="ruby-keyword kw">end</span>
159:           <span class="ruby-keyword kw">end</span>
160:         <span class="ruby-keyword kw">end</span>
161:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000050"></a><b>start_server</b>(ip,port,t_module,&amp;block)
  </div>
  <div class="description">
  <p>
method opens a socket for listening
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000050_source')" id="l_M000050_source">show source</a> ]</p>
  <div id="M000050_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 131</span>
131:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_server</span>(<span class="ruby-identifier">ip</span>,<span class="ruby-identifier">port</span>,<span class="ruby-identifier">t_module</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
132:         <span class="ruby-constant">BasicSocket</span>.<span class="ruby-identifier">do_not_reverse_lookup</span> = <span class="ruby-keyword kw">true</span>
133:         <span class="ruby-comment cmt"># configure_socket_options</span>
134:         <span class="ruby-identifier">t_socket</span> = <span class="ruby-constant">TCPServer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ip</span>,<span class="ruby-identifier">port</span>.<span class="ruby-identifier">to_i</span>)
135:         <span class="ruby-comment cmt"># t_socket.setsockopt(*@tcp_defer_accept_opts) rescue nil</span>
136:         <span class="ruby-identifier">listen_sockets</span>[<span class="ruby-identifier">t_socket</span>.<span class="ruby-identifier">fileno</span>] = { <span class="ruby-identifier">:socket</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">t_socket</span>,<span class="ruby-identifier">:block</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">block</span>,<span class="ruby-identifier">:module</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">t_module</span> }
137:         <span class="ruby-ivar">@read_ios</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t_socket</span>
138:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000053"></a><b>terminate_me</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000053_source')" id="l_M000053_source">show source</a> ]</p>
  <div id="M000053_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 167</span>
167:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">terminate_me</span>
168:         <span class="ruby-comment cmt"># FIXME: close the open sockets</span>
169:         <span class="ruby-identifier">exit</span>
170:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000052"></a><b>user_thread_window</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000052_source')" id="l_M000052_source">show source</a> ]</p>
  <div id="M000052_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/core.rb, line 163</span>
163:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">user_thread_window</span>
164:         <span class="ruby-identifier">run_user_threads</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:run_user_threads</span>)
165:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>