<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Module: Packet::Deferrable</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Module</span><br />Packet::Deferrable</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../files/framework/deferrable_rb.html">framework/deferrable.rb</a>
        </td>
      </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">




  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000023">callback</a></li>
  <li><a href="#M000027">cancel_timeout</a></li>
  <li><a href="#M000024">errback</a></li>
  <li><a href="#M000031">fail</a></li>
  <li><a href="#M000029">set_deferred_failure</a></li>
  <li><a href="#M000025">set_deferred_status</a></li>
  <li><a href="#M000028">set_deferred_success</a></li>
  <li><a href="#M000030">succeed</a></li>
  <li><a href="#M000026">timeout</a></li>
  </ul>






<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000023"></a><b>callback</b>(&amp;block)
  </div>
  <div class="description">
  <p>
Specify a block to be executed if and when the <a
href="Deferrable.html">Deferrable</a> object receives a status of
:succeeded. See <a href="Deferrable.html#M000025">set_deferred_status</a>
for more information.
</p>
<p>
Calling this method on a <a href="Deferrable.html">Deferrable</a> object
whose status is not yet known will cause the <a
href="Deferrable.html#M000023">callback</a> block to be stored on an
internal list. If you call this method on a <a
href="Deferrable.html">Deferrable</a> whose status is :succeeded, the block
will be executed immediately, receiving the parameters given to the prior
<a href="Deferrable.html#M000025">set_deferred_status</a> call.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000023_source')" id="l_M000023_source">show source</a> ]</p>
  <div id="M000023_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File framework/deferrable.rb, line 48</span>
48:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">callback</span> <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>
49:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">block</span>
50:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@deferred_status</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:succeeded</span>
51:         <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-operator">*</span><span class="ruby-ivar">@deferred_args</span>)
52:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@deferred_status</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">:failed</span>
53:         <span class="ruby-ivar">@callbacks</span> <span class="ruby-operator">||=</span> []
54:         <span class="ruby-ivar">@callbacks</span>.<span class="ruby-identifier">unshift</span> <span class="ruby-identifier">block</span> <span class="ruby-comment cmt"># &lt;&lt; block</span>
55:       <span class="ruby-keyword kw">end</span>
56:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000027"></a><b>cancel_timeout</b>()
  </div>
  <div class="description">
  <p>
Cancels an outstanding <a href="Deferrable.html#M000026">timeout</a> if
any. Undoes the action of <a href="Deferrable.html#M000026">timeout</a>.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000027_source')" id="l_M000027_source">show source</a> ]</p>
  <div id="M000027_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/deferrable.rb, line 167</span>
167:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cancel_timeout</span>
168:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@deferred_timeout</span>
169:         <span class="ruby-ivar">@deferred_timeout</span>.<span class="ruby-identifier">cancel</span>
170:         <span class="ruby-ivar">@deferred_timeout</span> = <span class="ruby-keyword kw">nil</span>
171:       <span class="ruby-keyword kw">end</span>
172:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000024"></a><b>errback</b>(&amp;block)
  </div>
  <div class="description">
  <p>
Specify a block to be executed if and when the <a
href="Deferrable.html">Deferrable</a> object receives a status of :failed.
See <a href="Deferrable.html#M000025">set_deferred_status</a> for more
information.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000024_source')" id="l_M000024_source">show source</a> ]</p>
  <div id="M000024_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File framework/deferrable.rb, line 65</span>
65:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">errback</span> <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>
66:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">block</span>
67:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@deferred_status</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:failed</span>
68:         <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-operator">*</span><span class="ruby-ivar">@deferred_args</span>)
69:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@deferred_status</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">:succeeded</span>
70:         <span class="ruby-ivar">@errbacks</span> <span class="ruby-operator">||=</span> []
71:         <span class="ruby-ivar">@errbacks</span>.<span class="ruby-identifier">unshift</span> <span class="ruby-identifier">block</span> <span class="ruby-comment cmt"># &lt;&lt; block</span>
72:       <span class="ruby-keyword kw">end</span>
73:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000031"></a><b>fail</b>(*args)
  </div>
  <div class="description">
  <p>
Can&#8216;t get enough sugar
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000031_source')" id="l_M000031_source">show source</a> ]</p>
  <div id="M000031_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/deferrable.rb, line 195</span>
195:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fail</span> <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>
196:       <span class="ruby-identifier">set_deferred_failure</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
197:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000029"></a><b>set_deferred_failure</b>(*args)
  </div>
  <div class="description">
  <p>
Equivalent to <a
href="Deferrable.html#M000025">set_deferred_status</a>(:failed, &#8230;)
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000029_source')" id="l_M000029_source">show source</a> ]</p>
  <div id="M000029_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/deferrable.rb, line 183</span>
183:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_deferred_failure</span> <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>
184:       <span class="ruby-identifier">set_deferred_status</span> <span class="ruby-identifier">:failed</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>
185:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000025"></a><b>set_deferred_status</b>(status, *args)
  </div>
  <div class="description">
  <p>
Sets the &quot;disposition&quot; (status) of the <a
href="Deferrable.html">Deferrable</a> object. See also the large set of
sugarings for this method. Note that if you call this method without
arguments, no arguments will be passed to the callback/errback. If the user
has coded these with arguments, then the user code will throw an argument
exception. Implementors of deferrable classes <b>must</b> document the
arguments they will supply to user callbacks.
</p>
<p>
OBSERVE SOMETHING VERY SPECIAL here: you may call this method even on the
INSIDE of a <a href="Deferrable.html#M000023">callback</a>. This is very
useful when a previously-registered <a
href="Deferrable.html#M000023">callback</a> wants to change the parameters
that will be passed to subsequently-registered ones.
</p>
<p>
You may give either :succeeded or :failed as the status argument.
</p>
<p>
If you pass :succeeded, then all of the blocks passed to the object using
the <a href="Deferrable.html#M000023">callback</a> method (if any) will be
executed BEFORE the <a
href="Deferrable.html#M000025">set_deferred_status</a> method returns. All
of the blocks passed to the object using <a
href="Deferrable.html#M000024">errback</a> will be discarded.
</p>
<p>
If you pass :failed, then all of the blocks passed to the object using the
<a href="Deferrable.html#M000024">errback</a> method (if any) will be
executed BEFORE the <a
href="Deferrable.html#M000025">set_deferred_status</a> method returns. All
of the blocks passed to the object using # <a
href="Deferrable.html#M000023">callback</a> will be discarded.
</p>
<p>
If you pass any arguments to <a
href="Deferrable.html#M000025">set_deferred_status</a> in addition to the
status argument, they will be passed as arguments to any callbacks or
errbacks that are executed. It&#8216;s your responsibility to ensure that
the argument lists specified in your callbacks and errbacks match the
arguments given in calls to <a
href="Deferrable.html#M000025">set_deferred_status</a>, otherwise Ruby will
raise an ArgumentError.
</p>
<p>
&#8212; We&#8216;re shifting callbacks off and discarding them as we
execute them. This is valid because by definition callbacks are executed no
more than once. It also has the magic effect of permitting recursive calls,
which means that a <a href="Deferrable.html#M000023">callback</a> can call
<a href="Deferrable.html#M000025">set_deferred_status</a> and change the
parameters that will be sent to subsequent callbacks down the chain.
</p>
<p>
Changed @callbacks and @errbacks from push/shift to unshift/pop, per
suggestion by Kirk Haines, to work around the memory leak bug that still
exists in many Ruby versions.
</p>
<p>
Changed 15Sep07: after processing callbacks or errbacks, CLEAR the other
set of handlers. This gets us a little closer to the behavior of
Twisted&#8216;s &quot;deferred,&quot; which only allows status to be set
once. Prior to making this change, it was possible to &quot;<a
href="Deferrable.html#M000030">succeed</a>&quot; a <a
href="Deferrable.html">Deferrable</a> (triggering its callbacks), and then
immediately &quot;<a href="Deferrable.html#M000031">fail</a>&quot; it,
triggering its errbacks! That is clearly undesirable, but it&#8216;s just
as undesirable to raise an exception is status is set more than once on a
<a href="Deferrable.html">Deferrable</a>. The latter behavior would
invalidate the idiom of resetting arguments by setting status from within a
<a href="Deferrable.html#M000023">callback</a> or <a
href="Deferrable.html#M000024">errback</a>, but more seriously it would
cause spurious errors if a <a href="Deferrable.html">Deferrable</a> was
timed out and then an attempt was made to <a
href="Deferrable.html#M000030">succeed</a> it. See the comments under the
new method <a href="Deferrable.html#M000026">timeout</a>.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000025_source')" id="l_M000025_source">show source</a> ]</p>
  <div id="M000025_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/deferrable.rb, line 127</span>
127:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_deferred_status</span> <span class="ruby-identifier">status</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>
128:       <span class="ruby-comment cmt">#cancel_timeout</span>
129:       <span class="ruby-ivar">@deferred_status</span> = <span class="ruby-identifier">status</span>
130:       <span class="ruby-ivar">@deferred_args</span> = <span class="ruby-identifier">args</span>
131:       <span class="ruby-keyword kw">case</span> <span class="ruby-ivar">@deferred_status</span>
132:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:succeeded</span>
133:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@callbacks</span>
134:           <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">cb</span> = <span class="ruby-ivar">@callbacks</span>.<span class="ruby-identifier">pop</span>
135:             <span class="ruby-identifier">cb</span>.<span class="ruby-identifier">call</span>(<span class="ruby-operator">*</span><span class="ruby-ivar">@deferred_args</span>)
136:           <span class="ruby-keyword kw">end</span>
137:         <span class="ruby-keyword kw">end</span>
138:         <span class="ruby-ivar">@errbacks</span>.<span class="ruby-identifier">clear</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@errbacks</span>
139:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:failed</span>
140:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@errbacks</span>
141:           <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">eb</span> = <span class="ruby-ivar">@errbacks</span>.<span class="ruby-identifier">pop</span>
142:             <span class="ruby-identifier">eb</span>.<span class="ruby-identifier">call</span>(<span class="ruby-operator">*</span><span class="ruby-ivar">@deferred_args</span>)
143:           <span class="ruby-keyword kw">end</span>
144:         <span class="ruby-keyword kw">end</span>
145:         <span class="ruby-ivar">@callbacks</span>.<span class="ruby-identifier">clear</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@callbacks</span>
146:       <span class="ruby-keyword kw">end</span>
147:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000028"></a><b>set_deferred_success</b>(*args)
  </div>
  <div class="description">
  <p>
Equivalent to <a
href="Deferrable.html#M000025">set_deferred_status</a>(:succeeded, &#8230;)
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000028_source')" id="l_M000028_source">show source</a> ]</p>
  <div id="M000028_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/deferrable.rb, line 177</span>
177:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_deferred_success</span> <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>
178:       <span class="ruby-identifier">set_deferred_status</span> <span class="ruby-identifier">:succeeded</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>
179:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000030"></a><b>succeed</b>(*args)
  </div>
  <div class="description">
  <p>
And still more sugar
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000030_source')" id="l_M000030_source">show source</a> ]</p>
  <div id="M000030_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/deferrable.rb, line 189</span>
189:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">succeed</span> <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>
190:       <span class="ruby-identifier">set_deferred_success</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
191:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000026"></a><b>timeout</b>(seconds)
  </div>
  <div class="description">
  <p>
Setting a <a href="Deferrable.html#M000026">timeout</a> on a <a
href="Deferrable.html">Deferrable</a> causes it to go into the failed state
after the Timeout expires (passing no arguments to the object&#8216;s
errbacks). Setting the status at any time prior to a call to the expiration
of the <a href="Deferrable.html#M000026">timeout</a> will cause the timer
to be cancelled.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000026_source')" id="l_M000026_source">show source</a> ]</p>
  <div id="M000026_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File framework/deferrable.rb, line 157</span>
157:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timeout</span> <span class="ruby-identifier">seconds</span>
158:       <span class="ruby-identifier">cancel_timeout</span>
159:       <span class="ruby-identifier">me</span> = <span class="ruby-keyword kw">self</span>
160:       <span class="ruby-ivar">@deferred_timeout</span> = <span class="ruby-constant">EventMachine</span><span class="ruby-operator">::</span><span class="ruby-constant">Timer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">seconds</span>) {<span class="ruby-identifier">me</span>.<span class="ruby-identifier">fail</span>}
161:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>